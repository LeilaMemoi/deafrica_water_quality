# deafrica_water_quality

repo for code development to produce a water quality service

Organised by work packages, at least in part.

## wq command line tools

### Installation

Clone this repository and `cd` into the repository folder `cd deafrica_water_quality/`.
Run the following command to install the python package:
`pip install -e .`

### Usage

The `water-quality` packages provides a set of tools to generate water quality variables from a variety of Earth Observation sensors.

#### Steps to run wq

#### 1. Save tasks

From your Sandbox (or a machine that has access to your ODC database), run:

```bash
generate-tasks tasks.txt
```

The output of this command is a text file containing a list of tile ids for the prospective run.

``` bash
Usage: wq-generate-tasks [OPTIONS] OUTPUT_FILE

  Get the list of tiles to run the DE Africa Water Quality workflow on and
  write the tile IDs to the file OUTPUT_FILE.

Options:
  --place-name TEXT  Optional name of a test area to generate tiles for. To
                     view the names of these predefined test areas, run the
                     command `wq-list-test-areas`.

```

#### 2. Process the tasks

To process the tiles from the previous step, the command `wq-process-tasks` requires:

1. The file containing the tile IDs for the tiles to process, generated from the previous step.
2. The output directory to write the netCDF file containing the water quality variables generated for each processed tile.
3. The total number of parallel workers or pods expected in
  the workflow. This value is used to divide the list of input tiles among the
  available workers.
4. The sequential index (0-indexed) of the current worker. This
  index determines which subset of tiles the current worker will process.
5. A YAML configuration file describing the time range for the analysis, the instruments to use, water frequency thresholds, etc.

``` bash
Usage: wq-process-tasks [OPTIONS] INPUT_FILE OUTPUT_DIRECTORY
                        MAX_PARALLEL_STEPS WORKER_IDX

  Get the Water Quality variables for the input tiles and write the resulting
  water quality variables to netCDF files.

  INPUT_FILE: The path to the text file containing the tile ids for the tiles
  to be processed. The text file is generated by running the `wq-generate-
  tasks` command.

  OUTPUT_DIRECTORY: The directory to write the water quality variables NETCDF
  file to for each tile.

  MAX_PARALLEL_STEPS: The total number of parallel workers or pods expected in
  the workflow. This value is used to divide the list of input tiles among the
  available workers.

  WORKER_IDX: The sequential index (0-indexed) of the current worker. This
  index determines which subset of tiles the current worker will process.

Options:
  --analysis-config TEXT        Config for the analysis parameters in yaml
                                format, file or text  [required]
  --overwrite / --no-overwrite  If overwrite is True tasks that have already
                                been processed will be rerun.   [default: no-
                                overwrite]
  --help                        Show this message and exit.

```

Sample `cfg.yaml`:

````yaml
start_date: 2023
end_date: 2024
instruments_to_use:
  oli_agm:
    use: true
  oli:
    use: false
  msi_agm:
    use: true
  msi:
    use: false
  tm_agm:
    use: true
  tm:
    use: false
  tirs:
    use: false
  wofs_ann:
    use: true
  wofs_all:
    use: true
water_frequency_threshold_high: 0.5
water_frequency_threshold_low: 0.1
permanent_water_threshold : 0.0875
sigma_coefficient : 1.2
```
